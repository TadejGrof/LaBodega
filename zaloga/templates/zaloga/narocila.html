{% extends 'program/base.html' %}

{% load zaloga_exstras %}

{% block css %}
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
{% endblock %}

{% block content %}

<style>

</style>


<div>
    <div class="inline">
        <button class="btn btn-outline-info" onclick="page('pregled_narocil')"> Pregled vseh narocil</button>
    </div>
    <div class="inline">
        <button class="btn btn-outline-info" onclick="page('analiza')"> Analiza narocil </button>
    </div>
</div>

<script>
    function page(page_name){
        $(".page").addClass("skrit");
        $("." + page_name).removeClass("skrit");
    }
</script>

<div class="page pregled_narocil">
    <h2 style="margin:2%">
        NOVO NAROČILO
    </h2>

    <div>
        <form method="POST" action="{% url 'novo_narocilo' zaloga_pk %}">
            {% csrf_token %}
            <select name="stranka">
                {% for stranka in stranke %}
                    {% with stranka=stranke|keyvalue:stranka %}
                        {% if not stranka.ima_model %}
                            <option value="{{stranka.id}}"> {{stranka.naziv}} </option>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </select>
            <input type="submit" value="Novo narocilo"> 
        </form>
    </div>

    <h2 style="margin:2%">
        NAROČILA
    </h2>

    <div class="w-100 d-flex justify-content-center">
        <div class="w-75 modeli">
            <table class="table table-striped">
                <tr>
                    <th> Stranka: </th>
                    <th> Skupno število: </th>
                    <th colspan="2"> Ogled </th>
                </tr>
                {% for model in modeli %}
                <tr>
                    <td class="col-sm-3">
                        {{model.stranka.naziv}}
                    </td>
                    <td class="col-sm-3">
                        {{model.skupno_stevilo}}
                    </td>
                    <td class="col-sm-3">
                        <form action="{% url 'baza' zaloga_pk 'narocilo' model.id %}" method="GET">
                            <input class="btn btn-info" type="submit" value="{{slovar|keyvalue:'Ogled'|keyvalue:jezik}}">
                        </form>
                    </td>
                    <td class="col-sm-3">
                        <button class="btn btn-info"> Info </button>
                    </td>
                </tr>
            {% endfor %}
            </table>
            
            

        </div>
    </div>
</div>

<style>
    
</style>

<form hidden="hidden" id="pdf_form"  action="{% url 'pdf_analize' zaloga_pk %}" method="GET">
    <input type="text" name="query" id="pdf_query" />
    <input type="text" name="skupina" id="pdf_skupina" />
</form>

<div style="margin-top:2%" class="page analiza skrit">
    <div style="height:85%" class="container analiza_div">
        <div class="h-100 row">
            <div class="col-9">
                <div class="h-25 row filter">
                    <div class="col">
                        <div class="row">
                            <label class="col-sm-3"> Dimenzija-Tip: </label>
                            <input class="col-sm-3" id="query" name="query" value="" type="text" />
                            <label class="col-sm-3"> Skupina: </label>
                            <select onchange="filtrirajStranke()" class="col-sm-3" id="skupina">
                                <option value="all"> All </option>
                                {% for skupina in skupine %}
                                    <option value="{{skupina.id}}"> {{skupina.naziv}} </option>
                                {% endfor %}
                            </select>   
                        </div>
                        <div class="row">
                            <label for="kontejnerji" class="form-check-label col-5"> Vključi prihajajoče kontejnerje: </label>
                            <input style="width:100%;margin:8px" class="col-1" type="checkbox" id="kontejnerji"/>
                            
                            <div class="col col-3"> <label class="skrit"> Do: </label></div>
                            <div class="col col-3"> <input class="skrit" type="date" id="datum" /></div> 
                             
                        </div>
                        <div class="row">
                            <div class="col">
                                <button class="btn btn-success" onclick="analiza()"> Filtriraj </button>
                                <button class="btn btn-primary" onclick="pdf()"> PDF </button>
                            </div> 
                        </div>
                    </div>
                    
                </div>
                <div id="analiza_tabela" class="h-75 row">
                    {% include './tabela_analize_narocil.html' %}
                </div>
            </div>
            
            <div class="h-100 overflow-auto col-3">
                <div class=" row tabela_strank">
                    <table id="tabela_strank" class="table table-striped">
                        <thead>
                            <tr>
                                <th> Stranka: </th>
                                <th> Odstrani: </th>
                            </tr>
                        </thead>
                        {% for stranka in stranke.values %}
                            {% if stranka.ima_model %}
                                <tr class="stranka">
                                    <td class="skrit skupina"> {{stranka.skupina_id}} </td>
                                    <td> {{stranka.naziv}} </td>
                                    <td> <button onclick="removeStranka(this)" class="btn btn-outline-danger"> - </button> </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    var reversals = {
        0: false,
        3: false,
        4: true,
        5: true,
    }

    function filtrirajStranke(){
        console.log("FILTRIRAM");
        var skupina = $("#skupina").val();
        var vrstice = $("#tabela_strank tr.stranka");
        vrstice.addClass("skrit");
        console.log(skupina);
        
        if(skupina == "all"){
            vrstice.removeClass("skrit");
        } else {
            vrstice.each(function(){
                console.log(parseInt($("td.skupina",$(this)).html()));
                console.log(parseInt(skupina));
                console.log(parseInt($("td.skupina",$(this)).html()) == parseInt(skupina));
                if(parseInt($("td.skupina",$(this)).html()) == parseInt(skupina)){
                    $(this).removeClass("skrit");
                }
            });
        }

    }

    function removeStranka(button){
        $(button).closest("tr").addClass("skrit");
    }

    function sortTable(index){
        var table = $("#tabela_vnosov").eq(0);
        var rows = table.find('tr').toArray().sort(comparer(index))
        var asc = reversals[index]

        if (!asc){rows = rows.reverse()}
        for (var i = 0; i < rows.length; i++){table.append(rows[i])}
        reversals[index] = !asc;
    }

    function comparer(index) {
        return function(a, b) {
            var valA = getCellValue(a, index), valB = getCellValue(b, index)
            if(index == 5){
                return parseInt(valA.toString().replace("+","")) - parseInt(valB.toString().replace("+",""));
            } else {
                return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
            }
        }
    }
    function getCellValue(row, index){ return $(row).children('td').eq(index).text() }

    function analiza(){
        var query = $("#query").val();
        var skupina = $("#skupina").val();
        $.ajax({
            url: '{% url "analiza_narocil" zaloga_pk %}',
            method: 'GET',
            data: {
            'query': query,
            'skupina': skupina,
            },
            dataType: 'json',
            success: function (data) {
                console.log("SUCCES");
                console.log(data);
                $("#analiza_tabela").html(data["html"]);
            }
        }); 
        
    }

    function pdf(){
        var query = $("#query").val();
        var skupina = $("#skupina").val();
        console.log(query);
        console.log(skupina);
        $("#pdf_query").val(query);
        $("#pdf_skupina").val(skupina);
        $("#pdf_form").submit();
        console.log("FOMR SUBMITED");
    }

</script>


{% endblock %}