{% extends 'program/base.html' %}


{% load zaloga_exstras %}

{% block content %}
<div style="width:100%;display:table;margin-bottom:2%">
    <div style="width:60%;text-align:center;display:table-cell;vertical-align:middle">
        <h1> Skupen pregled narocil <h1>
    </div>
    <div style="width:39%;text-align:center;display:table-cell">
        <h3> Ostala naroƒçila: </h3>
        <table class="tabela_vnosov" style="width:80%;margin-left:10%">
            {% for narocilo in ostala_narocila %}
                <tr>
                    <td> {{narocilo.stranka__ime}}</td>
                    <td>
                        <form action="{% url 'skupen_pregled_narocil' zaloga_pk %}" method="GET">
                            <input type="submit" value="Dodaj">
                            <input type="hidden" name="gledane" value="{{gledane|dodaj:narocilo.pk}}">
                        </form>
                    </td>
                </td>
            {% endfor %}
        </table>
    </div>
</div>


<div style="width:95%;display:inline-block;text-aling:center">
    <table class="tabela_vnosov">
        <tr>
            <th style="width:7%"> Dimenzija/Tip </th>
            {% for narocilo in narocila %}
                <th style="width:{{85|divide:stevilo_narocil}}%" onclick="barva('td','white');barva('{{narocilo.stranka__ime}}','#ffe6e6')"> 
                    <form action="{% url 'skupen_pregled_narocil' zaloga_pk %}" method="GET">
                        <input type="submit" value="-" id="submit_{{narocilo.pk}}" onclick="Nastavi_top('{{narocilo.pk}}')">
                        <input type="hidden" value="{{gledane|odstrani:narocilo.pk}}" name="gledane">
                        <input type="number" hidden="hidden" value="" id="top_{{narocilo.pk}}" name="top">
                    </form>
                    <div style="width:100%;height:40%;overflow:hidden">{{narocilo.stranka__ime}}</div>
                </th>
            {% endfor %}
            {% if ostalo %}
                <th style="width:4%"> Ostalo </th>
            {% endif %} 
            <th style="width:4%"> Skupno </th>
            <th style="width:4%"> Zaloga </th>
        </tr>
        {% with zaloga=zaloga.dimenzija_tip_zaloga %}
            {% for dimenzija in razlicne_dimenzije %}
                <tr onclick="barva('td','white');barva('{{dimenzija}}','#ffe6e6')">
                    <td class="td {{dimenzija}}"> {{dimenzija}} </td>
                    {% for narocilo in narocila %}
                        {% if narocilo.stranka__pk in razlicne_dimenzije|keyvalue:dimenzija %}
                            <td class="td {{dimenzija}} {{narocilo.stranka__ime}}"> 
                                {% for vnos in razlicne_dimenzije|keyvalue:dimenzija|keyvalue:narocilo.stranka__pk %}    
                                    {% with stevilo=razlicne_dimenzije|keyvalue:dimenzija|keyvalue:narocilo.stranka__pk|keyvalue:vnos %}
                                        {% if stevilo == 1 %}
                                            <button id="izbrisi_{{vnos}}" onclick="Izbrisi_vnos('{{vnos}}','{{dimenzija}}')"> - </button>
                                            <button style="display:none" id="odstej_{{vnos}}" onclick="Spremeni_vnos(-1,'{{vnos}}','{{dimenzija}}')"> - </button>
                                        {% else %}
                                            <button style="display:none" id="izbrisi_{{vnos}}" onclick="Izbrisi_vnos('{{vnos}}','{{dimenzija}}')"> - </button>
                                            <button id="odstej_{{vnos}}" onclick="Spremeni_vnos(-1,'{{vnos}}','{{dimenzija}}')"> - </button>
                                        {% endif %}
                                    <div id="stevilo_{{vnos}}" style="display:inline-block"> {{stevilo}} </div>
                                    <button id="pristej_{{vnos}}" onclick="Spremeni_vnos(1,'{{vnos}}','{{dimenzija}}')"> + </button>
                                    <button style="display:none" id="{{dimenzija}}_novo_{{narocilo.pk}}" onclick="Ustvari_vnos('{{narocilo.pk}}','{{dimenzija}}')"> + </button>
                                    {% endwith %}
                                {% endfor %}
                            </td>
                        {% else %}
                            <td class="td {{dimenzija}} {{narocilo.stranka__ime}}"> 
                                <button style="display:none" id="{{dimenzija}}_izbrisi_{{narocilo.pk}}"> - </button>
                                <button style="display:none" id="{{dimenzija}}_odstej_{{narocilo.pk}}"> - </button>
                                <div id="{{dimenzija}}_stevilo_{{narocilo.pk}}" style="display:inline-block"> 0 </div>
                                <button id="{{dimenzija}}_novo_{{narocilo.pk}}" onclick="Ustvari_vnos('{{narocilo.pk}}','{{dimenzija}}')"> + </button>
                                <button style="display:none" id="{{dimenzija}}_pristej_{{narocilo.pk}}"> + </button>
                            </td>
                        {% endif %}
                    {% endfor %}
                    {% if ostalo %}
                        <td class="td {{dimenzija}}">
                            {% if 'ostalo' in razlicne_dimenzije|keyvalue:dimenzija %}
                                {{razlicne_dimenzije|keyvalue:dimenzija|keyvalue:'ostalo'}}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                    {% endif %}
                    <td class="td {{dimenzija}}" id="skupno_{{dimenzija}}"> {{skupno|keyvalue:dimenzija }} </td>
                    <td class="td {{dimenzija}}"> {{zaloga|keyvalue:dimenzija}} </td>
                </tr>
            {% endfor %}
        {% endwith %}
        <tr>
            <td> Skupno: </td>
            {% for narocilo in narocila %}
                <td> {{narocilo.skupno}} </td>
            {% endfor %}
            <td> Skupno: </td>
            <td> {{skupno.stevilo}} </td>
        </tr>
    </table>
</div>

<h2> Dodaj vnos </h2>

<form action="{% url 'baza_nov_vnos' zaloga.pk 'vele_prodaja' 0 %}" method="POST" style="margin-bottom:3%">
    {% csrf_token %}
    Stranka: 
    <select name="pk">
        {% for narocilo in narocila %}
            <option value="{{narocilo.pk}}"> {{narocilo.stranka__ime}} </option>
        {% endfor%}
    </select>
    Dimenzija: 
    <select name="dimenzija">
        {% for dimenzija in program.vrni_dimenzije %}
            <option value="{{dimenzija.0}}"> {{dimenzija.0}} </option>
        {% endfor %}
    </select>
    Tip: 
    <select name="tip">
        {% for tip in zaloga.tipi_sestavin %}
            <option  value="{{tip}}"> {{tip}} </option>
        {% endfor %}
    </select>
    Stevilo: <input name="stevilo" type="number" required>
    <input type="submit"  value="Nov vnos">
    <input type="hidden" value="{{gledane}}" name="gledane">
<form>
{% endblock %}

{% block javascript %}
  <script>
    function Spremeni_vnos(predznak, pk, dimenzija) {
      var stevilo = parseInt(get_innerHtml('stevilo_' + pk)) + predznak
      var skupno = parseInt(get_innerHtml('skupno_' + dimenzija)) + predznak
      $.ajax({
        url: '{% url "spremeni_vnos" %}',
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{csrf_token}}',
          'stevilo': stevilo,
          'pk': pk,
        },
        dataType: 'json',
        success: function (data) {
          set_innerHtml('stevilo_' + pk, stevilo);
          set_innerHtml('skupno_' + dimenzija, skupno);
          if(stevilo == 1){
              document.getElementById('pristej_' + pk).style.display ="inline-block"
              document.getElementById('izbrisi_' + pk).style.display ="inline-block"
              document.getElementById('odstej_' + pk).style.display ="none"
          } else{
              document.getElementById('pristej_' + pk).style.display ="inline-block"
              document.getElementById('izbrisi_' + pk).style.display ="none"
              document.getElementById('odstej_' + pk).style.display ="inline-block"
          }
        }
      }); 
    }
    function Ustvari_vnos(pk, dimenzija_tip) {
      var skupno = parseInt(get_innerHtml('skupno_' + dimenzija_tip)) + 1
      var dimenzija = dimenzija_tip.split('_')[0]
      var tip = dimenzija_tip.split('_')[1]
      $.ajax({
        url: '{% url "nov_vnos" %}',
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{csrf_token}}',
          'pk': pk,
          'stevilo': 1,
          'dimenzija':dimenzija,
          'tip':tip,
        },
        dataType: 'json',
        success: function (data) {
          set_id(dimenzija_tip + '_stevilo_' + pk, 'stevilo_' + data.pk) 
          set_id(dimenzija_tip + '_pristej_' + pk, 'pristej_' + data.pk)
          set_id(dimenzija_tip + '_odstej_' + pk, 'odstej_' + data.pk)
          set_id(dimenzija_tip + '_izbrisi_' + pk, 'izbrisi_' + data.pk)
          set_innerHtml('skupno_' + dimenzija_tip, skupno);
          set_innerHtml('stevilo_' + data.pk, 1);
          document.getElementById(dimenzija_tip +'_novo_' + pk).style.display = "none"
          document.getElementById('pristej_' + data.pk).style.display = "inline-block"
          document.getElementById('izbrisi_' + data.pk).style.display = "inline-block"
          document.getElementById('pristej_' + data.pk).onclick = function() { Spremeni_vnos(1,data.pk,dimenzija_tip); }
          document.getElementById('odstej_' + data.pk).onclick = function() { Spremeni_vnos(-1,data.pk,dimenzija_tip); }
          document.getElementById('izbrisi_' + data.pk).onclick = function() { Izbrisi_vnos(data.pk,dimenzija_tip); }
        }
      }); 
    }
    function Izbrisi_vnos(pk, dimenzija) {
      var skupno = parseInt(get_innerHtml('skupno_' + dimenzija)) - 1
      $.ajax({
        url: '{% url "izbrisi_vnos" %}',
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{csrf_token}}',
          'pk': pk,
        },
        dataType: 'json',
        success: function (data) {
          set_id('stevilo_' + pk,dimenzija + '_stevilo_' + data.pk) 
          set_id('pristej_' + pk,dimenzija + '_pristej_' + data.pk)
          set_id('odstej_' + pk,dimenzija + '_odstej_' + data.pk)
          set_id('izbrisi_' + pk,dimenzija + '_izbrisi_' + data.pk)
          set_innerHtml('skupno_' + dimenzija, skupno);
          set_innerHtml(dimenzija + '_stevilo_' + data.pk, 0);
          document.getElementById(dimenzija +'_novo_' + data.pk).style.display = "inline-block"
          document.getElementById(dimenzija + '_pristej_' + data.pk).style.display = "none"
          document.getElementById(dimenzija + '_izbrisi_' + data.pk).style.display = "none"
        }
      }); 
    }
  </script>
{% endblock %}