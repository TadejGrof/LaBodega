{% extends 'program/base.html' %}


{% load zaloga_exstras %}

{% block content %}
<div style="width:100%;display:table;margin-bottom:2%">
    <div style="width:60%;text-align:center;display:table-cell;vertical-align:middle">
        <h1> Skupen pregled narocil <h1>
    </div>
    <div style="width:39%;text-align:center;display:table-cell">
        <h3> Ostala naroƒçila: </h3>
    </div>
</div>


<div style="width:95%;display:inline-block;text-aling:center">
    <table class="tabela_vnosov">
        <tr>
            <th style="width:7%"> Dimenzija/Tip </th>
            {% for narocilo in narocila %}
                <th  onclick="barva('td','white');barva('{{narocilo.stranka__ime}}','#ffe6e6')"> 
                    <form action="{% url 'skupen_pregled_narocil' zaloga_pk %}" method="GET">
                        <input type="submit" value="-" id="submit_{{narocilo.pk}}" onclick="Nastavi_top('{{narocilo.pk}}')">
                        <input type="hidden" name="gledane">
                        <input type="number" hidden="hidden" value="" id="top_{{narocilo.pk}}" name="top">
                    </form>
                    <div style="width:100%;height:40%;overflow:hidden">{{narocilo.stranka__ime}}</div>
                </th>
            {% endfor %} 
            <th style="width:4%"> Skupno </th>
            <th style="width:4%"> Zaloga </th>
        </tr>
        {% with zaloga=zaloga.dimenzija_tip_zaloga %}
            {% for dimenzija in razlicne_dimenzije %}
                <tr id="{{dimenzija|replace}}" class="vrstica {{dimenzija|replace}}" onclick="barva('td','white');barva('{{dimenzija}}','#ffe6e6')">
                    <td class="td {{dimenzija|replace}}"> {{dimenzija}} </td>
                    {% for narocilo in narocila %}
                        {% if narocilo.pk in razlicne_dimenzije|keyvalue:dimenzija %}
                            <td id="{{dimenzija|replace}}_{{narocilo.pk}}" class="td {{dimenzija|replace}} narocilo"> 
                                {% for vnos in razlicne_dimenzije|keyvalue:dimenzija|keyvalue:narocilo.pk %}    
                                    {% with stevilo=razlicne_dimenzije|keyvalue:dimenzija|keyvalue:narocilo.pk|keyvalue:vnos %}
                                        <div  id="{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}" class="vnos">
                                            <input id="pk_{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}" type="text" class="skrit pk" value="{{vnos}}">
                                            <button id="izbrisi_{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}" onclick="Izbrisi_vnos('{{vnos}}','{{dimenzija}}')"> - </button>
                                            <button id="odstej_{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}" onclick="Spremeni_vnos(-1,'{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}')"> - </button>
                                            <div id="stevilo_{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}" class="inline"> {{stevilo}} </div>
                                            <button id="pristej_{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}" onclick="Spremeni_vnos(1,'{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}')"> + </button>
                                            <button id="dodaj_{{dimenzija|replace}}_{{narocilo.pk}}_{{forloop.counter}}" onclick="Ustvari_vnos('{{narocilo.pk}}','{{dimenzija}}')"> + </button>
                                        </div>
                                    {% endwith %}
                                {% endfor %}
                            </td>
                        {% else %}
                            <td id="{{dimenzija|replace}}_{{narocilo.pk}}" class="td {{dimenzija|replace}} narocilo"> 
                                <div id="{{dimenzija|replace}}_{{narocilo.pk}}_1" class="vnos">
                                    <input type="text" class="skrit pk" value="">
                                    <button id="izbrisi_{{dimenzija|replace}}_{{narocilo.pk}}_1"> - </button>
                                    <button id="odstej_{{dimenzija|replace}}_{{narocilo.pk}}_1" > - </button>
                                    <div id="stevilo_{{dimenzija|replace}}_{{narocilo.pk}}_1" class="inline"> 0 </div>
                                    <button id="pristej_{{dimenzija|replace}}_{{narocilo.pk}}_1" onclick="Ustvari_vnos('{{narocilo.pk}}','{{dimenzija}}')"> + </button>
                                    <button id="dodaj_{{dimenzija|replace}}_{{narocilo.pk}}_1"> + </button>
                                </div>
                            </td>
                        {% endif %}
                    {% endfor %}
                    <td class="td {{dimenzija}}" id="skupno_{{dimenzija}}"> {{skupno|keyvalue:dimenzija}} </td>
                    <td class="td {{dimenzija}}"> {{na_voljo|keyvalue:dimenzija}} </td>
                </tr>
            {% endfor %}
        {% endwith %}
        <tr>
            <td> Skupno: </td>
            {% for narocilo in narocila %}
                <td> {{narocilo.skupno}} </td>
            {% endfor %}
            <td> Skupno: </td>
            <td> {{skupno.stevilo}} </td>
        </tr>
    </table>
</div>

{% endblock %}

{% block javascript %}
  <script>
     $(document).ready(function() {
        var vrstice = $('.vrstica')
        for (i=0; i<vrstice.length; i++){
            var vrstica = vrstice[i]
            var narocila = $('#' + vrstica.id + ' td.narocilo')
            for(n=0; n<narocila.length; n++){
                var narocilo = narocila[n]
                var vnosi = $('#' + narocilo.id +  ' div.vnos')
                for(v=0;v<vnosi.length;v++){
                    var vnos=vnosi[v]
                    var pk = $('#' + vnos.id + ' input.pk')[0].value
                    Nastavi_gumbe(vnos.id, pk)
                }
            }
        }
    });
    function Nastavi_gumbe(id,pk){
        Pokazi_gumbe(id)
        if(pk != ""){
            var stevilo = parseInt(get_innerHtml('stevilo_' + id))
            $('#dodaj_' + id).addClass('skrit')
            if(stevilo > 1){
                $('#izbrisi_' + id).addClass('skrit')
            } else{
                $('#odstej_' + id).addClass('skrit')
            }
        } else {
            $('#izbrisi_' + id).addClass('skrit')
            $('#odstej_' + id).addClass('skrit')
            $('#pristej_' + id).addClass('skrit')
        }
    }
    function Pokazi_gumbe(id){
        $('#izbrisi_' + id).removeClass('skrit')
        $('#odstej_' + id).removeClass('skrit')
        $('#pristej_' + id).removeClass('skrit')
        $('#dodaj_' + id).removeClass('skrit')
    }
    function Spremeni_vnos(predznak, id) {
      var stevilo = parseInt(get_innerHtml('stevilo_' + id)) + predznak
      var pk = get_value('pk_' + id)
      $.ajax({
        url: '{% url "spremeni_vnos" %}',
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{csrf_token}}',
          'stevilo': stevilo,
          'pk': pk,
        },
        dataType: 'json',
        success: function (data) {
          set_innerHtml('stevilo_' + id, data.stevilo);
          Nastavi_gumbe(id, data.pk)
          
        }
      }); 
    }
    function Ustvari_vnos(pk, dimenzija_tip) {
      var skupno = parseInt(get_innerHtml('skupno_' + dimenzija_tip)) + 1
      var dimenzija = dimenzija_tip.split('_')[0]
      var tip = dimenzija_tip.split('_')[1]
      $.ajax({
        url: '{% url "nov_vnos" %}',
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{csrf_token}}',
          'pk': pk,
          'stevilo': 1,
          'dimenzija':dimenzija,
          'tip':tip,
        },
        dataType: 'json',
        success: function (data) {
          set_id(dimenzija_tip + '_stevilo_' + pk, 'stevilo_' + data.pk) 
          set_id(dimenzija_tip + '_pristej_' + pk, 'pristej_' + data.pk)
          set_id(dimenzija_tip + '_odstej_' + pk, 'odstej_' + data.pk)
          set_id(dimenzija_tip + '_izbrisi_' + pk, 'izbrisi_' + data.pk)
          set_innerHtml('skupno_' + dimenzija_tip, skupno);
          set_innerHtml('stevilo_' + data.pk, 1);
          document.getElementById(dimenzija_tip +'_novo_' + pk).style.display = "none"
          document.getElementById('pristej_' + data.pk).style.display = "inline-block"
          document.getElementById('izbrisi_' + data.pk).style.display = "inline-block"
          document.getElementById('pristej_' + data.pk).onclick = function() { Spremeni_vnos(1,data.pk,dimenzija_tip); }
          document.getElementById('odstej_' + data.pk).onclick = function() { Spremeni_vnos(-1,data.pk,dimenzija_tip); }
          document.getElementById('izbrisi_' + data.pk).onclick = function() { Izbrisi_vnos(data.pk,dimenzija_tip); }
        }
      }); 
    }
    function Izbrisi_vnos(pk, dimenzija) {
      var skupno = parseInt(get_innerHtml('skupno_' + dimenzija)) - 1
      $.ajax({
        url: '{% url "izbrisi_vnos" %}',
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{csrf_token}}',
          'pk': pk,
        },
        dataType: 'json',
        success: function (data) {
          set_id('stevilo_' + pk,dimenzija + '_stevilo_' + data.pk) 
          set_id('pristej_' + pk,dimenzija + '_pristej_' + data.pk)
          set_id('odstej_' + pk,dimenzija + '_odstej_' + data.pk)
          set_id('izbrisi_' + pk,dimenzija + '_izbrisi_' + data.pk)
          set_innerHtml('skupno_' + dimenzija, skupno);
          set_innerHtml(dimenzija + '_stevilo_' + data.pk, 0);
          document.getElementById(dimenzija +'_novo_' + data.pk).style.display = "inline-block"
          document.getElementById(dimenzija + '_pristej_' + data.pk).style.display = "none"
          document.getElementById(dimenzija + '_izbrisi_' + data.pk).style.display = "none"
        }
      }); 
    }
  </script>
{% endblock %}